---
date: 2023-12-21
category:
 - çæŠ˜è…¾
 - åšå®¢å»ºç«™
tag:
 - Git
 - Git Hooks
title: åˆ©ç”¨Git Hooksè‡ªåŠ¨æ‰“åŒ…éƒ¨ç½²
description: ä»€ä¹ˆï¼Ÿ2050å¹´äº†ä½ è¿˜åœ¨æ‰‹åŠ¨ä¸Šä¼ æœåŠ¡å™¨ç„¶åæ‰‹åŠ¨æ‰“åŒ…éƒ¨ç½²ï¼Ÿ
---

ä»€ä¹ˆï¼Ÿ2050å¹´äº†ä½ è¿˜åœ¨æ‰‹åŠ¨ä¸Šä¼ æœåŠ¡å™¨ç„¶åæ‰‹åŠ¨æ‰“åŒ…éƒ¨ç½²ï¼Ÿ

<!-- more -->

æ¥[ä¸Šæ–‡](Gitéƒ¨ç½²ç§æœ)ï¼Œåšå®¢çš„ä»“åº“æ˜¯æ¬åˆ°æœåŠ¡å™¨ä¸Šäº†ï¼Œå¦‚ä½•å½“ä¸€ä¸ªæ’’æ‰‹æŒæŸœå‘¢ï¼Œè®©æˆ‘æ¯æ¬¡å†™å®Œåªç®¡pushï¼Œå‰©ä¸‹çš„æ‰“åŒ…è‡ªåŠ¨éƒ¨ç½²è‡ªåŠ¨è¿›è¡Œå‘¢ï¼Ÿ

è¿™é‡Œå°±è¦ç”¨åˆ°æˆ‘ä»¬çš„Git Hooks

## Git Hooks

é¦–å…ˆæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹Git Hooksï¼Œçœ‹[å®˜ç½‘](https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90)çš„è§£é‡Šå°±å¥½äº†ï¼Œç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯åœ¨gitçš„å·¥ä½œæµç¨‹ä¸­åˆ†ä¸ºå‡ ä¸ªå…³é”®çš„æ—¶é—´èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯é’©å­ï¼Œåœ¨åˆ°è¾¾æ—¶é—´èŠ‚ç‚¹æ—¶ï¼Œgitä¼šæ‰§è¡Œå¯¹åº”çš„è‡ªå®šä¹‰è„šæœ¬

æœ‰äº†è¿™ç©æ„ï¼Œå°±å·²ç»æˆåŠŸä¸€åŠäº†ï¼Œæˆ‘ä»¬ä¸å°±æ˜¯æƒ³è®©æˆ‘ä»¬åœ¨pushä¹‹åæœåŠ¡å™¨å»è‡ªåŠ¨è¿è¡Œæ‰“åŒ…å‘½ä»¤å—ï¼Œé‚£é—®é¢˜å°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦è®©æœåŠ¡å™¨åœ¨æ”¶åˆ°æ¨é€åè¿›è¡Œæ‰“åŒ…å³å¯

## è„šæœ¬ç¼–å†™

Git Hooksçš„è‡ªå®šä¹‰è„šæœ¬ä½ç½®å°±åœ¨ä»“åº“çš„hooksç›®å½•ä¸­ï¼ŒæœåŠ¡å™¨å®¢æˆ·ç«¯éƒ½æœ‰

æˆ‘ä»¬åœ¨æ‰¾åˆ°æœåŠ¡å™¨çš„hooksç›®å½•ï¼Œå°†`post-update.sample`æ‹·è´ä¸€ä»½ï¼Œé‡å‘½åä¸º`post-update`ï¼Œè¿™æ ·æœåŠ¡å™¨å°±ä¼šåœ¨ä»“åº“å†…å®¹æ›´æ–°åè¿è¡Œè¯¥è„šæœ¬

```sh
# è¿›å…¥æœåŠ¡å™¨çš„gitä»“åº“çš„hooksç›®å½•ï¼Œè¿™ä¸ªè·¯å¾„åªæ˜¯ä¾‹å­ï¼Œæ ¹æ®å®é™…æƒ…å†µæ”¹å˜
cd path/to/git/repo/hooks

# å¤åˆ¶post-update.sampleå¹¶é‡å‘½å
cp post-update.sample post-update

# ç¼–è¾‘post-update
vim post-update
```

å…·ä½“å†…å®¹å¾ˆå¥½å†™ï¼Œæˆ‘ä»¬éšä¾¿æ‰¾ä¸€ä¸ªç›®å½•ï¼Œå°†ä»“åº“å†…å®¹cloneä¸‹æ¥ï¼Œç„¶åè¿è¡Œæ‰“åŒ…å‘½ä»¤å³å¯

```sh
# æŒ‡å®šäº†è„šæœ¬è¦ä½¿ç”¨çš„è§£é‡Šå™¨
#!/bin/bash

# è®©è„šæœ¬åœ¨ä»»ä½•å‘½ä»¤è¿”å›éé›¶ï¼ˆå‡ºç°é”™è¯¯ï¼‰æ—¶ç«‹å³é€€å‡º
set -e

# å–æ¶ˆå¯¹ç¯å¢ƒå˜é‡ GIT_DIR çš„è®¾ç½®ã€‚
# è¿™æ ·åšå¯ä»¥ç¡®ä¿åœ¨è„šæœ¬ä¸­ä½¿ç”¨çš„ Git å‘½ä»¤æ˜¯åŸºäºå½“å‰å·¥ä½œç›®å½•çš„ã€‚
unset GIT_DIR

# å®šä¹‰WORK_PATHå˜é‡ï¼ŒæŒ‡å®šå·¥ä½œç›®å½•ï¼Œå³ä½ è¦å…‹éš†ä»“åº“è¿›è¡Œæ‰“åŒ…çš„ä½ç½®
WORK_PATH='path/to/workspace'

cd $WORK_PATH

echo "cleaning workspace"

# ä½¿ç”¨ Git å‘½ä»¤é‡ç½®å·¥ä½œåŒºï¼Œå°†å…¶ä¸è¿œç¨‹ä»“åº“çš„åˆ†æ”¯ä¿æŒä¸€è‡´ã€‚
# --hard å‚æ•°è¡¨ç¤ºæ”¾å¼ƒæœ¬åœ°çš„ä¿®æ”¹ï¼Œç›´æ¥ä½¿ç”¨è¿œç¨‹ä»“åº“çš„å†…å®¹ã€‚
git reset --hard origin/your-branch

# æ¸…ç†å·¥ä½œåŒºä¸­æœªè¢« Git ç®¡ç†çš„æ–‡ä»¶
git clean -f

echo "pulling code"

# æ‹‰å–è¿œç¨‹ä»“åº“ä»£ç 
git pull origin your-branch

echo "building..."

# è¿è¡Œæ‰“åŒ…å‘½ä»¤ï¼Œè¿™é‡Œç”¨çš„vuepressæ‰“åŒ…å‘½ä»¤ä¸ºnpm run docs:buildï¼Œæ ¹æ®è‡ªå·±çš„æ›´æ”¹
npm run docs:build

echo "deploy done"                                   
```

æŒ‰ç†è¯´ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æ­£å¸¸è¿è¡Œçš„

ä½†æ˜¯ï¼Œæˆ‘è¿™è¾¹æ€»æ˜¯åœ¨pushä»¥åä¼šå¡ä½æ²¡æœ‰ååº”ï¼Œå¡åœ¨buildingçš„æ­¥éª¤ï¼Œæˆ‘ä»¥ä¸ºæ˜¯æˆ‘æœ¬åœ°çš„é—®é¢˜ï¼Œæ‰¾äº†ä¸€åœˆå‘ç°ï¼ŒæœåŠ¡å™¨ä¸€è¿è¡Œæ‰“åŒ…å‘½ä»¤å°±æ­»æœº

å¥½å®¶ä¼™ï¼Œæ²¡è¾™äº†ï¼Œè¿™ä¸ªæ–¹æ³•çœ‹æ¥æ˜¯èµ°ä¸é€šäº†ï¼Œåªèƒ½æƒ³åˆ«çš„åŠæ³•äº†

## Husky

æƒ³äº†å¾ˆå¤šæ–¹æ³•ï¼Œä¹Ÿçœ‹äº†å¾ˆå¤šæ–‡ç« ï¼Œé¦–å…ˆåœ¨å®¢æˆ·ç«¯ç”¨git hooksåœ¨æäº¤å‰æ‰“åŒ…æ˜¯ç™¾åˆ†ç™¾å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘å‘ç°äº†æ›´ç®€å•çš„æ–¹æ³•ï¼Œä½¿ç”¨[Husky](https://github.com/typicode/husky)

ä»€ä¹ˆæ˜¯Husky

å®˜ç½‘æ˜¯è¿™ä¹ˆè§£é‡Šçš„

Modern native git hooks made easy

Husky improves your commits and more ğŸ¶ woof!

é€šä¿—ç‚¹è¯´

ä»–å¯ä»¥è®©æˆ‘ä»¬å¾ˆè½»æ¾åœ°ä½¿ç”¨Git Hooksï¼Œåœ¨æäº¤ä»£ç æ—¶è¿è¡Œæˆ‘ä»¬æƒ³è¦çš„è„šæœ¬ã€‚

æˆ‘çœ‹äº†å¥½å¤šä¾‹å­éƒ½æ˜¯ç”¨æ¥åšä»£ç è´¨é‡æ£€æµ‹çš„ï¼Œåƒæˆ‘è¿™ç§ä¸€ä¸ªäººå†™çš„å±å±±å°±ä¸éœ€è¦äº†ï¼ˆbushi

å®ƒçš„å·¥ä½œåŸç†æ˜¯åœ¨æˆ‘ä»¬çš„ package.json æ–‡ä»¶ä¸­åŠ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œé…ç½® Husky æ¥è¿è¡Œæˆ‘ä»¬æŒ‡å®šçš„è„šæœ¬ã€‚ä¹‹åï¼ŒHuskyä¼šç®¡ç†æˆ‘ä»¬çš„è„šæœ¬å°†åœ¨Gitç”Ÿå‘½å‘¨æœŸçš„å“ªä¸ªé˜¶æ®µè¿è¡Œã€‚

æˆ‘ä»¬é¦–å…ˆå®‰è£…Husky

```sh
npm install husky
```

æ–°ç‰ˆæœ¬çš„Huskyä¸­æˆ‘ä»¬ä¸ç”¨åœ¨`package.json`é…ç½®ï¼Œè€Œæ˜¯åœ¨`.husky`ç›®å½•ä¸‹é…ç½®

æˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨`package.json`ä¸­çš„`scripts`ä¸­æ·»åŠ `prepare`è„šæœ¬

```json
{
  "scripts": {
    "prepare": "husky install"
  }
}
```

`prepare`è„šæœ¬ä¼šåœ¨`npm install`ä¹‹åè‡ªåŠ¨æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬æ‰§è¡Œ`npm install`å®‰è£…å®Œé¡¹ç›®ä¾èµ–åä¼šæ‰§è¡Œ`husky install`å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä¼šåˆ›å»º`.husky`ç›®å½•å¹¶æŒ‡å®šè¯¥ç›®å½•ä¸ºgit hooksæ‰€åœ¨çš„ç›®å½•ã€‚

ç„¶åæ·»åŠ git hooks

```sh
# npx husky add .husky/pre-commit \
# "echo [Husky] project building \
# && æ‰“åŒ…å‘½ä»¤ \
# && å°†æ‰“åŒ…åçš„æ–‡ä»¶å¤¹æ·»åŠ çš„æš‚å­˜åŒºâ€œ
# å¦‚
npx husky add .husky/pre-commit "echo [Husky] project building \
&& npm run docs:build \
&& git add src/.vuepress/dist -f"
```

ç„¶åä½ å°±èƒ½çœ‹åˆ°`.husky`ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª`pre-commit`çš„è„šæœ¬

å†…å®¹å¦‚ä¸‹

```sh
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo [Husky] project building && npm run docs:build && git add src/.vuepress/dist -f
```

åœ¨æ¯æ¬¡git commitä¹‹å‰éƒ½ä¼šè¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œç„¶åå°†æ‰“åŒ…å®Œæˆçš„ä»£ç ä¸€å—æäº¤ç»™æœåŠ¡å™¨ï¼Œè™½ç„¶æ¯æ¬¡commitéƒ½è¦ç­‰ä¸€ä¸‹ï¼Œä½†æ€»æ¯”æœåŠ¡å™¨æ­»æœºå¼ºå¤šäº†

è¿™æ—¶å€™æˆ‘ä»¬å°±è¦æ”¹ä¸€ä¸‹æœåŠ¡å™¨é‚£è¾¹çš„`post-update`è„šæœ¬äº†

æˆ‘ä»¬åªéœ€è¦åœ¨æ”¶åˆ°æ›´æ–°åç›´æ¥å°†ä»“åº“å…‹éš†ä¸‹æ¥å°±å¥½

```sh
#!/bin/bash
set -e
unset GIT_DIR
WORK_PATH='path/to/workspace'

cd $WORK_PATH

echo "cleaning workspace"
git reset --hard origin/your-branch
git clean -f

echo "pulling code"
git pull origin your-branch

# è·Ÿä¸Šè¾¹å·®åˆ«ä¸å¤§ï¼Œåªæ˜¯ä¸ç”¨æ‰“åŒ…äº†è€Œå·²ï¼Œæ ¹æ®nginxçš„é…ç½®ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œä¸€ä¸‹æ‹·è´æ“ä½œ
# ä¾‹å¦‚ï¼š
# cp ./src/.vuepress/dist /www/blog
# echo "building..."
# npm run docs:build

echo "deploy done"                                   
```

## Nginxé…ç½®

é¡ºå¸¦ä¸€ä¸‹ä¸€ä»½nginxçš„é…ç½®ï¼Œæ‡’å¾—å†™æ³¨é‡Šäº†ï¼Œåº”è¯¥éƒ½æŒºå¥½ç†è§£çš„ï¼Œä¸æ‡‚çš„æœä¸€ä¸‹å°±å¥½äº†

```nginx
server {    
    listen 443 ssl;
    server_name your.domain; 

    ssl_certificate path/to/your/cert;
    ssl_certificate_key path/to/your/cert/key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
    ssl_prefer_server_ciphers on;

    location / {
        root path/to/your/dist/folder;
        index index.html;
    }
}

server {
    listen 80;
    server_name your.domain;
    rewrite ^(.*)$ https://$host$1 permanent;
}
```